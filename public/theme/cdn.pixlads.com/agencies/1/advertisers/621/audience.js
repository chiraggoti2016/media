var districtmPixel=districtmPixel||{};districtmPixel.env="prod";districtmPixel.advertiserId=621;districtmPixel.agencyId=1;districtmPixel.conversionUrlParams=["%2Forder"];districtmPixel.segmentKVPs=[];districtmPixel.dynamicRetargeting="none";districtmPixel.dynamicRetargetingSetUrl="";districtmPixel.removeUserFromAllSegments="false";districtmPixel.convertOnCall="true";districtmPixel.targetEUVisitors="false";districtmPixel.hasActiveDynamicCampaign="false";districtmPixel.activateFlag="false";districtmPixel.googleEventSnippetId="811106223\/SXybCLLk3YMBEK__4YID";districtmPixel.googleGlobalSiteTagId="811106223";districtmPixel.facebookAdsPixelId="335224627130613";(function(){var startTime=new Date();var districtm=districtm||{};if(typeof districtmPixel==='undefined'){districtmPixel={};}
if(typeof districtmPixel.env==='undefined'){districtmPixel.env='prod';}
if(typeof districtmPixel.removeUserFromAllSegments==='undefined'||districtmPixel.removeUserFromAllSegments==='false'){districtmPixel.removeUserFromAllSegments=false;}
if(typeof districtmPixel.conversionUrlParams==='undefined'){districtmPixel.conversionUrlParams=[];}
if(typeof districtmPixel.segmentKVPs==='undefined'){districtmPixel.segmentKVPs=[];}
if(typeof districtmPixel.convertOnCall==='undefined'||districtmPixel.convertOnCall==='false'){districtmPixel.convertOnCall=false;}
if(typeof districtmPixel.targetEUVisitors==='undefined'||districtmPixel.targetEUVisitors==='false'){districtmPixel.targetEUVisitors=false;}
if(typeof districtmPixel.hasActiveDynamicCampaign==='undefined'||districtmPixel.hasActiveDynamicCampaign==='false'){districtmPixel.hasActiveDynamicCampaign=false;}
if(typeof districtmPixel.activateFlag==='undefined'||districtmPixel.activateFlag==='false'){districtmPixel.activateFlag=false;}
districtmPixel.dcreative={};districtmPixel.localStorageDomain="https://staging-cdn.pixlads.com";districtmPixel.apiUrl="http://magpie.staging.districtm.ca/api/";if(districtmPixel.env==='prod'){districtmPixel.localStorageDomain="https://cdn.pixlads.com";districtmPixel.apiUrl="https://app.districtm.net/api/";}
districtmPixel.dcreative.saveUrl=districtmPixel.localStorageDomain+"/agencies/"+districtmPixel.agencyId+"/advertisers/"+districtmPixel.advertiserId+"/save"+districtmPixel.advertiserId+".html";var hasAdword=false;var hasFacebook=false;var adWordAdded=false;var SPAInterval=500;var segmentCodes=[];var hasConverted=false;var recordedTimeouts=[];var timeoutIds=0;var currentPageUrl=window.location.href;var facebookScriptTag=document.createElement('script');if(typeof districtmPixel.facebookAdsPixelId!=='undefined'){hasFacebook=true;}
if(typeof districtmPixel.googleEventSnippetId!=='undefined'&&typeof districtmPixel.googleGlobalSiteTagId!=='undefined'){hasAdword=true;}
window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
districtm.Base64={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(e){var t="";var n,r,i,s,o,u,a;var f=0;e=districtm.Base64._utf8_encode(e);while(f<e.length){n=e.charCodeAt(f++);r=e.charCodeAt(f++);i=e.charCodeAt(f++);s=n>>2;o=(n&3)<<4|r>>4;u=(r&15)<<2|i>>6;a=i&63;if(isNaN(r)){u=a=64}else if(isNaN(i)){a=64}t=t+this._keyStr.charAt(s)+this._keyStr.charAt(o)+this._keyStr.charAt(u)+this._keyStr.charAt(a)}return t},decode:function(e){var t="";var n,r,i;var s,o,u,a;var f=0;e=e.replace(/[^A-Za-z0-9\+\/\=]/g,"");while(f<e.length){s=this._keyStr.indexOf(e.charAt(f++));o=this._keyStr.indexOf(e.charAt(f++));u=this._keyStr.indexOf(e.charAt(f++));a=this._keyStr.indexOf(e.charAt(f++));n=s<<2|o>>4;r=(o&15)<<4|u>>2;i=(u&3)<<6|a;t=t+String.fromCharCode(n);if(u!=64){t=t+String.fromCharCode(r)}if(a!=64){t=t+String.fromCharCode(i)}}t=districtm.Base64._utf8_decode(t);return t},_utf8_encode:function(e){e=e.replace(/\r\n/g,"\n");var t="";for(var n=0;n<e.length;n++){var r=e.charCodeAt(n);if(r<128){t+=String.fromCharCode(r)}else if(r>127&&r<2048){t+=String.fromCharCode(r>>6|192);t+=String.fromCharCode(r&63|128)}else{t+=String.fromCharCode(r>>12|224);t+=String.fromCharCode(r>>6&63|128);t+=String.fromCharCode(r&63|128)}}return t},_utf8_decode:function(e){var t="";var n=0;var r=c1=c2=0;while(n<e.length){r=e.charCodeAt(n);if(r<128){t+=String.fromCharCode(r);n++}else if(r>191&&r<224){c2=e.charCodeAt(n+1);t+=String.fromCharCode((r&31)<<6|c2&63);n+=2}else{c2=e.charCodeAt(n+1);c3=e.charCodeAt(n+2);t+=String.fromCharCode((r&15)<<12|(c2&63)<<6|c3&63);n+=3}}return t}};districtm.audience={run:function(advertiserId){hasConverted=false;if(hasFacebook){this.buildFacebook();}
if(districtmPixel.convertOnCall){this.bindConvertOnCall(advertiserId);}
this.buildAndFireRetargeting(advertiserId);hasConverted=this.conditionallyFireConversion(advertiserId);if(!(hasConverted&&districtmPixel.removeUserFromAllSegments==="true")){this.buildAndFireAdvanced();}
var data={};data.id=advertiserId;this.triggerMTracker('sload',data);if(hasAdword&&!adWordAdded){this.buildAndAddAdword();adWordAdded=true;}
if(hasFacebook){this.addFacebook();}},runGDPRCheck:function(callback){var self=this;var req=new XMLHttpRequest();req.open('GET','https://services.districtm.net/gdpr/v1');req.onreadystatechange=function(){if(req.readyState===4){if(req.status===200){try{if(JSON.parse(req.responseText)){if(!JSON.parse(req.responseText).gdprApplies||districtmPixel.targetEUVisitors){callback();}else{return false;}}}catch(e){console.log(e);}}}};req.send(null);},activateStatus:function(){var img=new Image();img.src=districtmPixel.apiUrl+"audience-activation?advertiser="+districtmPixel.advertiserId;},buildAndAddAdword:function(){var scriptTag=document.createElement('script');scriptTag.setAttribute("async","");scriptTag.src="https://www.googletagmanager.com/gtag/js?id=AW-"+districtmPixel.googleGlobalSiteTagId;document.body.appendChild(scriptTag);gtag('js',new Date());gtag('config','AW-'+districtmPixel.googleGlobalSiteTagId);},buildFacebook:function(){facebookScriptTag.innerHTML+="!function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){n.callMethod?"+
"n.callMethod.apply(n,arguments):n.queue.push(arguments)};if(!f._fbq)f._fbq=n;"+
"n.push=n;n.loaded=!0;n.version='2.0';n.queue=[];t=b.createElement(e);t.async=!0;"+
"t.src=v;s=b.getElementsByTagName(e)[0];s.parentNode.insertBefore(t,s)}(window,"+
"document,'script','https://connect.facebook.net/en_US/fbevents.js');"+
"fbq('init', '"+districtmPixel.facebookAdsPixelId+"');"+
"fbq('track', 'PageView');";},addFacebook:function(){document.body.appendChild(facebookScriptTag);},bindConvertOnCall:function(advertiserId){var links=window.document.getElementsByTagName("a");var self=this;if(document.readyState!=='loading'){for(var i=0;i<links.length;i++){if(links[i].href.indexOf('tel:')===0){links[i].addEventListener("click",function(){self.buildAndFireConversion(advertiserId,"contact");});}}}else{document.addEventListener('DOMContentLoaded',function(){for(var i=0;i<links.length;i++){if(links[i].href.indexOf('tel:')===0){links[i].addEventListener("click",function(){self.buildAndFireConversion(advertiserId,"contact");});}}});}},buildAndFireRetargeting:function(advertiserId){var globalRetargetingCode='pixl-'+districtmPixel.env+'-adv-segment-'+advertiserId;var globalRetargetingSegmentString=districtm.utils.buildSegmentString(globalRetargetingCode);segmentCodes.push(globalRetargetingCode);this.triggerSegment(globalRetargetingSegmentString);},conditionallyFireConversion:function(advertiserId){var self=this;for(var i=0;i<districtmPixel.conversionUrlParams.length;i++){if(districtm.utils.getUrl().indexOf(decodeURIComponent(districtmPixel.conversionUrlParams[i]))!=-1){this.buildAndFireConversion(advertiserId,"conversion");}}
return hasConverted;},buildAndFireConversion:function(advertiserId,type){if(hasConverted===false){var self=this;var conversionSegmentCode='pixl-'+districtmPixel.env+'-adv-pixel-'+advertiserId;if(districtmPixel.revenueValue>0){var conversionSegmentParams='&value='+revenueValue;conversionSegmentCode+=conversionSegmentParams;}
if(districtmPixel.removeUserFromAllSegments==="true"){var allSegments='';for(var k=0;k<segmentCodes.length;k++){allSegments+=segmentCodes[k];if(k<segmentCodes.length-1){allSegments+=',';}}
var removeParams='&remove_code='+allSegments;conversionSegmentCode+=removeParams;}
conversionSegmentCode+='&seg_code=pixl-'+districtmPixel.env+'-adv-conv-segment-'+advertiserId;var conversionUrlSegmentString=districtm.utils.buildConversionString(conversionSegmentCode);self.triggerSegment(conversionUrlSegmentString);hasConverted=true;}
if(hasAdword){gtag('event','conversion',{'send_to':'AW-'+districtmPixel.googleEventSnippetId});}
if(hasFacebook){if(type==='conversion'){if(typeof fbq==='function'){fbq('track','ViewContent');}else{facebookScriptTag.innerHTML+="fbq('track', 'ViewContent');"}}else if(type==='contact'){if(typeof fbq==='function'){fbq('track','Contact');}else{facebookScriptTag.innerHTML+="fbq('track', 'Contact');"}}}},buildAndFireAdvanced:function(){var self=this;for(var i=0;i<districtmPixel.segmentKVPs.length;i++){for(var k=0;k<districtmPixel.segmentKVPs[i].url.length;k++){if(districtm.utils.getUrl().indexOf(decodeURIComponent(districtmPixel.segmentKVPs[i].url[k]))!=-1){var advancedSegmentCode='pixl-'+districtmPixel.env+'-custom-segment-'+districtmPixel.segmentKVPs[i].id;segmentCodes.push(advancedSegmentCode);var advancedSegmentString=districtm.utils.buildSegmentString(advancedSegmentCode);if(districtmPixel.segmentKVPs[i].timer){var delay=districtmPixel.segmentKVPs[i].timer*1000-(new Date()-startTime);self.triggerAdvancedSegment(advancedSegmentString,delay)}else{self.triggerAdvancedSegment(advancedSegmentString,0)}}}}},runSPACheck:function(){var self=this;setInterval(function(){if(currentPageUrl!=window.location.href){for(var i=0;i<recordedTimeouts.length;i++){window.clearTimeout(recordedTimeouts[i]);}
segmentCodes=[];recordedTimeouts=[];timeoutIds=0;startTime=new Date();self.run(districtmPixel.advertiserId);currentPageUrl=window.location.href;}},SPAInterval);},setTimeoutWithId:function(delay,fn){recordedTimeouts[timeoutIds]=window.setTimeout(function(){fn()},delay);timeoutIds++;},triggerSegment:function(url){var img=new Image();img.src=url;},triggerAdvancedSegment:function(url,delay){var setImgSrcUrl=function(){var img=new Image();img.src=url;};this.setTimeoutWithId(delay,setImgSrcUrl);},triggerMTracker:function(event,data){if(typeof data.id!='undefined'){data.id=data.id.toString();}
var b64=districtm.Base64.encode(JSON.stringify(data));var img=new Image();var domain="dmx-staging.districtm.ca";if(districtmPixel.env==='prod'){domain="dmx.districtm.ca";}
img.src='//'+domain+'/mtracker/'+event+'/'+b64;},getMeta:function(){var output={};var metaList=document.getElementsByTagName("META");var hasMeta=false;for(var i=0;i<metaList.length;i++){if(metaList[i].name=="districtm"&&metaList[i].content=="ignore"){return false;}
if(metaList[i].name.split(':')[0]=="twitter"){var key=metaList[i].name.split(':')[1];if(metaList[i].name.split(':')[2]){key+=metaList[i].name.split(':')[2];}
var value=metaList[i].content;output[key]=value;hasMeta=true;}
if(metaList[i].attributes[0].value.split(':')[0]=="og"){var key=metaList[i].attributes[0].value.split(':')[1];if(metaList[i].attributes[0].value.split(':')[2]){key+=metaList[i].attributes[0].value.split(':')[2];}
var value=metaList[i].content;output[key]=value;hasMeta=true;}
if(metaList[i].name.split(':')[0]=="districtm"){var key=metaList[i].name.split(':')[1];var value=metaList[i].content;output[key]=value;hasMeta=true;}}
if(hasMeta){return output;}
else{return false;}},getImageB64:function(url,x,y,width,quality,callback){var img=document.createElement("img");img.crossOrigin='anonymous';img.onload=function(){try{imgRatio=img.width/img.height;var canvas=document.createElement("canvas");if(img.width>width){canvas.width=width;canvas.height=width/imgRatio;}
else{canvas.width=img.width;canvas.height=img.height;}
var ctx=canvas.getContext("2d");ctx.drawImage(img,x,y,canvas.width,canvas.height);if(url.includes('.png')){var dataStr=canvas.toDataURL("image/png");}
else{var dataStr=canvas.toDataURL("image/jpeg",quality);}
return callback(dataStr,canvas.width,canvas.height);}
catch(e){console.log(e);}}
img.onerror=function(){console.log('districtm: image error');return callback("",0,0);};img.src=url;},launchDynamic:function(){var meta=this.getMeta();if(meta&&districtmPixel.hasActiveDynamicCampaign==="true"){var data={};data.meta=meta;data.product="districtm_dynamic_creative";data.advertiserId=districtmPixel.advertiserId;data.url=window.location.href;this.getImageB64(data.meta.image,0,0,300,0.9,function(imageB64,width,height){data.meta.imageB64=imageB64;data.meta.imageB64Width=width;data.meta.imageB64Height=height;var iframe=districtm.utils.createIframe(districtmPixel.dcreative.saveUrl);document.getElementsByTagName('head')[0].appendChild(iframe);iframe.onload=function(){var dataString=JSON.stringify(data);iframeWin=iframe.contentWindow;iframeWin.postMessage(dataString,districtmPixel.dcreative.saveUrl);}});}}};districtm.utils={getUrl:function(){return window.location.href;},getTime:function(){return(new Date()).getTime();},createIframe:function(src){var f=document.createElement('iframe');f.src=src;f.width=0;f.height=0;f.border='0px';f.hspace='0';f.vspace='0';f.marginWidth='0';f.marginHeight='0';f.style.border='0';f.scrolling='no';f.frameBorder='0';f.setAttribute('allowtransparency','true');return f;},parseMeta:function(id){var self=this;var data={};data.kvps=[];data.advertiserId=id;data.timestamp=self.getTime();var metaTags=document.getElementsByTagName('meta');for(var i=0;i<metaTags.length;i++){if(metaTags[i].attributes.property.value.split(':')[0]=='pixl'){var att={};att.key=metaTags[i].attributes.property.value.split(':')[1];att.value=encodeURIComponent(metaTags[i].content);if(att.key=='product_id'){data.productId=att.value;}
data.kvps.push(att);}}
var b64=districtm.Base64.encode(JSON.stringify(data));var url=districtmPixel.dynamicRetargetingSetUrl+'?product='+b64;var iframe=self.createIframe(url);var elToAppend=document.getElementsByTagName('head')[0];elToAppend.insertBefore(iframe,elToAppend.firstChild);return true;},buildSegmentString:function(code){var url='https://secure.adnxs.com/seg?';var params='add_code=';params+=code;params+='&member=1908';params+='&t=2';url+=params;return url},buildConversionString:function(code){var url='https://secure.adnxs.com/px?';var params='code=';params+=code;params+='&member=1908';params+='&t=2';url+=params;return url}};districtm.audience.runGDPRCheck(function(){districtm.audience.run(districtmPixel.advertiserId)});districtm.audience.runSPACheck();if(document.readyState!=='loading'){districtm.audience.runGDPRCheck(districtm.audience.launchDynamic.bind(districtm.audience));}else{document.addEventListener('DOMContentLoaded',function(){districtm.audience.runGDPRCheck(districtm.audience.launchDynamic.bind(districtm.audience));});}
if(districtmPixel.activateFlag==="true"){districtm.audience.activateStatus();}
if(districtmPixel.dynamicRetargeting=='meta'){districtm.utils.parseMeta(districtmPixel.advertiserId);}
if(typeof exports!=='undefined'){exports.audience=districtm.audience;exports.utils=districtm.utils;}})();